---
export const prerender = false;

import { api } from "@/api/api-client";
import Modal from "@/components/admin/Modal.astro";
import AdminLayout from "@/layouts/AdminLayout.astro";
import type { Projects } from "@/types/types";
import { API_PATHS } from "@/utils/constants";

const user = Astro.locals.user;

let projects: Projects = [];
let error: string | null = null;

try {
  projects = await api.get<Projects>(API_PATHS.PROJECTS);
} catch (err) {
  error = err instanceof Error ? err.message : "Failed to load projects";
}

const formatDate = (date: Date | string | undefined): string => {
  if (!date) return "Ongoing";
  return new Date(date).toLocaleDateString("en-US", {
    year: "numeric",
    month: "short",
  });
};

const formatDateForInput = (date: Date | string | undefined): string => {
  if (!date) return "";
  return new Date(date).toISOString().split("T")[0];
};
---

<AdminLayout title="Projects" currentPath="/admin/projects" user={user}>
  {error && <div class="admin-alert admin-alert-error">{error}</div>}

  <div class="admin-card">
    <div class="admin-card-header">
      <h2 class="admin-card-title">All Projects</h2>
      <button
        type="button"
        class="admin-btn admin-btn-primary"
        onclick="openAddModal()"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Add Project
      </button>
    </div>

    {
      projects.length === 0 ? (
        <div class="admin-empty-state">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="48"
            height="48"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
          </svg>
          <p>No projects yet. Add your first project!</p>
        </div>
      ) : (
        <div class="admin-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Project</th>
                <th>URL</th>
                <th>Period</th>
                <th style="width: 120px">Actions</th>
              </tr>
            </thead>
            <tbody>
              {projects.map((project) => (
                <tr data-id={project.id}>
                  <td>
                    <strong style="color: var(--admin-text)">
                      {project.name}
                    </strong>
                    <div style="font-size: 0.8125rem; color: var(--admin-text-muted); max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                      {project.description}
                    </div>
                  </td>
                  <td>
                    {project.url ? (
                      <a
                        href={project.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        style="color: var(--admin-primary); font-size: 0.875rem;"
                      >
                        View Project
                      </a>
                    ) : (
                      <span style="color: var(--admin-text-muted)">-</span>
                    )}
                  </td>
                  <td>
                    {formatDate(project.startDate)} -{" "}
                    {formatDate(project.endDate)}
                  </td>
                  <td>
                    <div class="admin-table-actions">
                      <button
                        type="button"
                        class="admin-btn admin-btn-ghost admin-btn-sm admin-btn-icon"
                        onclick={`openEditModal(${JSON.stringify({
                          id: project.id,
                          name: project.name,
                          description: project.description,
                          url: project.url || "",
                          start_date: formatDateForInput(project.startDate),
                          end_date: formatDateForInput(project.endDate),
                        })})`}
                        title="Edit"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                        </svg>
                      </button>
                      <button
                        type="button"
                        class="admin-btn admin-btn-ghost admin-btn-sm admin-btn-icon"
                        onclick={`openDeleteModal(${project.id}, '${project.name.replace(/'/g, "\\'")}')`}
                        title="Delete"
                        style="color: var(--admin-danger)"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <polyline points="3 6 5 6 21 6" />
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                          <line x1="10" y1="11" x2="10" y2="17" />
                          <line x1="14" y1="11" x2="14" y2="17" />
                        </svg>
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )
    }
  </div>

  <Modal id="project-modal" title="Add Project">
    <form id="project-form" class="admin-form">
      <input type="hidden" name="id" />
      <div id="form-error" class="admin-alert admin-alert-error" hidden></div>

      <div class="admin-form-group">
        <label for="name" class="admin-label admin-label-required"
          >Project Name</label
        >
        <input
          type="text"
          id="name"
          name="name"
          class="admin-input"
          placeholder="e.g. E-commerce Platform"
          required
        />
      </div>

      <div class="admin-form-group">
        <label for="description" class="admin-label admin-label-required"
          >Description</label
        >
        <textarea
          id="description"
          name="description"
          class="admin-textarea"
          placeholder="Describe your project..."
          rows="4"
          required></textarea>
      </div>

      <div class="admin-form-group">
        <label for="url" class="admin-label">Project URL</label>
        <input
          type="url"
          id="url"
          name="url"
          class="admin-input"
          placeholder="https://github.com/username/project"
        />
        <p class="admin-help-text">
          Optional: GitHub, demo link, or project page
        </p>
      </div>

      <div class="admin-form-row">
        <div class="admin-form-group">
          <label for="start_date" class="admin-label admin-label-required"
            >Start Date</label
          >
          <input
            type="date"
            id="start_date"
            name="start_date"
            class="admin-input"
            required
          />
        </div>
        <div class="admin-form-group">
          <label for="end_date" class="admin-label">End Date</label>
          <input
            type="date"
            id="end_date"
            name="end_date"
            class="admin-input"
          />
          <p class="admin-help-text">Leave empty if ongoing</p>
        </div>
      </div>

      <div class="admin-form-actions">
        <button
          type="button"
          class="admin-btn admin-btn-ghost"
          onclick="closeModal('project-modal')">Cancel</button
        >
        <button
          type="submit"
          class="admin-btn admin-btn-primary"
          id="submit-btn">Create Project</button
        >
      </div>
    </form>
  </Modal>

  <Modal id="delete-modal" title="Delete Project">
    <p class="admin-confirm-text">
      Are you sure you want to delete <strong id="delete-item-name"></strong>?
    </p>
    <p class="admin-confirm-warning">This action cannot be undone.</p>
    <div
      id="delete-error"
      class="admin-alert admin-alert-error"
      style="margin-top: 1rem;"
      hidden
    >
    </div>
    <div class="admin-form-actions">
      <button
        type="button"
        class="admin-btn admin-btn-ghost"
        onclick="closeModal('delete-modal')">Cancel</button
      >
      <button
        type="button"
        class="admin-btn admin-btn-danger"
        id="confirm-delete-btn">Delete</button
      >
    </div>
  </Modal>
</AdminLayout>

<script>
  let currentDeleteId: number | null = null;

  function openAddModal() {
    const form = document.getElementById("project-form") as HTMLFormElement;
    const title = document.querySelector("#project-modal .admin-modal-title");
    const submitBtn = document.getElementById("submit-btn");

    form.reset();
    (form.querySelector('[name="id"]') as HTMLInputElement).value = "";
    if (title) title.textContent = "Add Project";
    if (submitBtn) submitBtn.textContent = "Create Project";

    (window as any).openModal("project-modal");
  }

  function openEditModal(data: Record<string, any>) {
    const form = document.getElementById("project-form") as HTMLFormElement;
    const title = document.querySelector("#project-modal .admin-modal-title");
    const submitBtn = document.getElementById("submit-btn");

    (form.querySelector('[name="id"]') as HTMLInputElement).value = data.id;
    (form.querySelector('[name="name"]') as HTMLInputElement).value = data.name;
    (form.querySelector('[name="description"]') as HTMLTextAreaElement).value =
      data.description;
    (form.querySelector('[name="url"]') as HTMLInputElement).value = data.url;
    (form.querySelector('[name="start_date"]') as HTMLInputElement).value =
      data.start_date;
    (form.querySelector('[name="end_date"]') as HTMLInputElement).value =
      data.end_date;

    if (title) title.textContent = "Edit Project";
    if (submitBtn) submitBtn.textContent = "Update Project";

    (window as any).openModal("project-modal");
  }

  function openDeleteModal(id: number, name: string) {
    currentDeleteId = id;
    const nameEl = document.getElementById("delete-item-name");
    if (nameEl) nameEl.textContent = name;
    (window as any).openModal("delete-modal");
  }

  document
    .getElementById("project-form")
    ?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target as HTMLFormElement;
      const formData = new FormData(form);
      const id = formData.get("id") as string;
      const errorEl = document.getElementById("form-error");
      const submitBtn = document.getElementById("submit-btn");

      const payload: Record<string, any> = {
        name: formData.get("name"),
        description: formData.get("description"),
        url: formData.get("url") || undefined,
        start_date: formData.get("start_date"),
        end_date: formData.get("end_date") || undefined,
      };

      if (submitBtn) submitBtn.textContent = "Saving...";
      if (errorEl) errorEl.hidden = true;

      try {
        const endpoint = id
          ? `/api/admin/projects/${id}`
          : "/api/admin/projects";
        const method = id ? "PATCH" : "POST";

        const response = await fetch(endpoint, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          credentials: "include",
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || "Failed to save project");
        }

        window.location.reload();
      } catch (err) {
        if (errorEl) {
          errorEl.textContent =
            err instanceof Error ? err.message : "An error occurred";
          errorEl.hidden = false;
        }
        if (submitBtn)
          submitBtn.textContent = id ? "Update Project" : "Create Project";
      }
    });

  document
    .getElementById("confirm-delete-btn")
    ?.addEventListener("click", async () => {
      if (!currentDeleteId) return;

      const errorEl = document.getElementById("delete-error");
      const btn = document.getElementById("confirm-delete-btn");

      if (btn) btn.textContent = "Deleting...";
      if (errorEl) errorEl.hidden = true;

      try {
        const response = await fetch(`/api/admin/projects/${currentDeleteId}`, {
          method: "DELETE",
          credentials: "include",
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || "Failed to delete");
        }

        window.location.reload();
      } catch (err) {
        if (errorEl) {
          errorEl.textContent =
            err instanceof Error ? err.message : "An error occurred";
          errorEl.hidden = false;
        }
        if (btn) btn.textContent = "Delete";
      }
    });

  // Expose functions globally
  (window as any).openAddModal = openAddModal;
  (window as any).openEditModal = openEditModal;
  (window as any).openDeleteModal = openDeleteModal;
</script>
