---
export const prerender = false;

import { api } from "@/api/api-client";
import Modal from "@/components/admin/Modal.astro";
import AdminLayout from "@/layouts/AdminLayout.astro";
import type { CareerCertifications } from "@/types/types";
import { API_PATHS } from "@/utils/constants";
import { asyncThrowable } from "@/utils/utils.ts";

const user = Astro.locals.user;

let error: string | null = null;

const [certifications, err] = await asyncThrowable(() =>
  api.get<CareerCertifications>(API_PATHS.UPLOAD_CERTIFICATES)
);

if (err) {
  error = err instanceof Error ? err.message : "Failed to load certifications";
}

const formatDate = (date: Date | string): string => {
  return new Date(date).toLocaleDateString("en-US", {
    year: "numeric",
    month: "short",
  });
};

const formatFileSize = (bytes: number): string => {
  if (bytes === 0) return "0 Bytes";
  const k = 1024;
  const sizes = ["Bytes", "KB", "MB", "GB"];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return `${Number.parseFloat((bytes / k ** i).toFixed(2))} ${sizes[i]}`;
};
---

<AdminLayout
  title="Certifications"
  currentPath="/admin/certifications"
  user={user}
>
  {error && <div class="admin-alert admin-alert-error">{error}</div>}

  <div class="admin-card" style="margin-bottom: 1.5rem;">
    <div class="admin-card-header">
      <h2 class="admin-card-title">Upload Certification</h2>
    </div>

    <div id="upload-error" class="admin-alert admin-alert-error" hidden></div>
    <div id="upload-success" class="admin-alert admin-alert-success" hidden>
    </div>

    <form id="certification-form" class="admin-form">
      <div class="admin-form-row">
        <div class="admin-form-group">
          <label for="title" class="admin-label admin-label-required"
            >Title</label
          >
          <input
            type="text"
            id="title"
            name="title"
            class="admin-input"
            placeholder="e.g., AWS Solutions Architect"
            required
          />
        </div>
        <div class="admin-form-group">
          <label for="issuer" class="admin-label admin-label-required"
            >Issuer</label
          >
          <input
            type="text"
            id="issuer"
            name="issuer"
            class="admin-input"
            placeholder="e.g., Amazon Web Services"
            required
          />
        </div>
      </div>

      <div class="admin-form-row">
        <div class="admin-form-group">
          <label for="issue_date" class="admin-label admin-label-required"
            >Issue Date</label
          >
          <input
            type="date"
            id="issue_date"
            name="issue_date"
            class="admin-input"
            required
          />
        </div>
        <div class="admin-form-group">
          <label for="expiry_date" class="admin-label">Expiry Date</label>
          <input
            type="date"
            id="expiry_date"
            name="expiry_date"
            class="admin-input"
          />
          <span class="admin-help-text">Leave empty if no expiration</span>
        </div>
      </div>

      <div class="admin-form-row">
        <div class="admin-form-group">
          <label for="credential_id" class="admin-label">Credential ID</label>
          <input
            type="text"
            id="credential_id"
            name="credential_id"
            class="admin-input"
            placeholder="e.g., ABC123XYZ"
          />
        </div>
        <div class="admin-form-group">
          <label for="credential_url" class="admin-label">Credential URL</label>
          <input
            type="url"
            id="credential_url"
            name="credential_url"
            class="admin-input"
            placeholder="https://verify.example.com/..."
          />
        </div>
      </div>

      <div class="admin-form-group">
        <label for="description" class="admin-label">Description</label>
        <textarea
          id="description"
          name="description"
          class="admin-textarea"
          rows="2"
          placeholder="Optional description about this certification"
        ></textarea>
      </div>

      <div class="admin-form-group">
        <label class="admin-label admin-label-required">Certificate File</label>
        <div class="upload-zone" id="upload-zone">
          <input
            type="file"
            id="cert-upload"
            name="files"
            accept=".jpg,.jpeg,.png,.webp,image/jpeg,image/png,image/webp"
            style="display: none;"
            required
          />
          <label for="cert-upload" class="upload-label">
            <div class="upload-icon">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="32"
                height="32"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
            </div>
            <p class="upload-text" id="upload-text">
              <strong>Click to select file</strong> or drag and drop
            </p>
            <p class="upload-hint">PNG, JPG, JPEG, WEBP up to 10MB</p>
          </label>
        </div>
        <div id="selected-file" class="selected-file" hidden>
          <span id="selected-file-name"></span>
          <button type="button" id="clear-file" class="clear-file-btn">
            Ã—
          </button>
        </div>
      </div>

      <div class="admin-form-actions">
        <button type="button" class="admin-btn admin-btn-ghost" id="reset-form">
          Clear
        </button>
        <button
          type="submit"
          class="admin-btn admin-btn-primary"
          id="submit-btn"
        >
          Upload Certification
        </button>
      </div>
    </form>
  </div>

  <div class="admin-card">
    <div class="admin-card-header">
      <h2 class="admin-card-title">All Certifications</h2>
    </div>

    {
      !certifications?.length ? (
        <div class="admin-empty-state">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="48"
            height="48"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="8" r="7" />
            <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88" />
          </svg>
          <p>No certifications yet. Upload your first certificate!</p>
        </div>
      ) : (
        <div class="admin-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Certification</th>
                <th>Issue Date</th>
                <th>File</th>
                <th style="width: 80px">Actions</th>
              </tr>
            </thead>
            <tbody>
              {certifications?.map((cert) => (
                <tr data-id={cert.id}>
                  <td>
                    <strong style="color: var(--admin-text)">
                      {cert.title}
                    </strong>
                    <div style="font-size: 0.8125rem; color: var(--admin-text-muted)">
                      {cert.issuer}
                    </div>
                  </td>
                  <td>{formatDate(cert.issue_date)}</td>
                  <td>
                    <a
                      href={cert.file_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      style="color: var(--admin-primary); font-size: 0.875rem;"
                    >
                      {cert.original_name}
                    </a>
                    <div style="font-size: 0.75rem; color: var(--admin-text-muted)">
                      {formatFileSize(cert.file_size)}
                    </div>
                  </td>
                  <td>
                    <div class="admin-table-actions">
                      <button
                        type="button"
                        class="admin-btn admin-btn-ghost admin-btn-sm admin-btn-icon"
                        onclick={`openDeleteModal(${cert.id}, '${cert.title.replace(/'/g, "\\'")}')`}
                        title="Delete"
                        style="color: var(--admin-danger)"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <polyline points="3 6 5 6 21 6" />
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                          <line x1="10" y1="11" x2="10" y2="17" />
                          <line x1="14" y1="11" x2="14" y2="17" />
                        </svg>
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )
    }
  </div>

  <Modal id="delete-modal" title="Delete Certification">
    <p class="admin-confirm-text">
      Are you sure you want to delete <strong id="delete-item-name"></strong>?
    </p>
    <p class="admin-confirm-warning">This action cannot be undone.</p>
    <div
      id="delete-error"
      class="admin-alert admin-alert-error"
      style="margin-top: 1rem;"
      hidden
    >
    </div>
    <div class="admin-form-actions">
      <button
        type="button"
        class="admin-btn admin-btn-ghost"
        onclick="closeModal('delete-modal');"
        >Cancel
      </button>
      <button
        type="button"
        class="admin-btn admin-btn-danger"
        id="confirm-delete-btn"
        >Delete
      </button>
    </div>
  </Modal>
</AdminLayout>

<style>
  .upload-zone {
    border: 2px dashed var(--admin-border);
    border-radius: 0.75rem;
    padding: 2rem;
    text-align: center;
    transition: all 0.2s ease;
  }

  .upload-zone:hover,
  .upload-zone.dragover {
    border-color: var(--admin-primary);
    background: rgba(99, 102, 241, 0.05);
  }

  .upload-zone.has-file {
    border-color: var(--admin-success);
    background: rgba(34, 197, 94, 0.05);
  }

  .upload-label {
    cursor: pointer;
    display: block;
  }

  .upload-icon {
    color: var(--admin-text-muted);
    margin-bottom: 1rem;
  }

  .upload-text {
    color: var(--admin-text);
    margin: 0 0 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .upload-hint {
    color: var(--admin-text-muted);
    font-size: 0.8125rem;
    margin: 0;
  }

  .selected-file {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    margin-top: 0.75rem;
    background: var(--admin-surface);
    border: 1px solid var(--admin-success);
    border-radius: 0.5rem;
    color: var(--admin-text);
  }

  .selected-file span {
    font-size: 0.875rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .clear-file-btn {
    background: none;
    border: none;
    color: var(--admin-text-muted);
    font-size: 1.25rem;
    cursor: pointer;
    padding: 0;
    line-height: 1;
    transition: color 0.2s;
  }

  .clear-file-btn:hover {
    color: var(--admin-danger);
  }
</style>

<script>
  let currentDeleteId: number | null = null;
  let selectedFile: File | null = null;

  const ALLOWED_TYPES = ["image/jpeg", "image/png", "image/webp"];
  const ALLOWED_EXTENSIONS = [".jpg", ".jpeg", ".png", ".webp"];

  function isValidImageFile(file: File): boolean {
    const extension = "." + file.name.split(".").pop()?.toLowerCase();
    return (
      ALLOWED_TYPES.includes(file.type) ||
      ALLOWED_EXTENSIONS.includes(extension)
    );
  }

  const form = document.getElementById("certification-form") as HTMLFormElement;
  const uploadInput = document.getElementById(
    "cert-upload"
  ) as HTMLInputElement;
  const uploadZone = document.getElementById("upload-zone");
  const uploadText = document.getElementById("upload-text");
  const uploadError = document.getElementById("upload-error");
  const uploadSuccess = document.getElementById("upload-success");
  const selectedFileEl = document.getElementById("selected-file");
  const selectedFileName = document.getElementById("selected-file-name");
  const clearFileBtn = document.getElementById("clear-file");
  const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement;
  const resetFormBtn = document.getElementById("reset-form");

  function formatDate(dateStr: string): string {
    if (!dateStr) return "";
    const date = new Date(dateStr);
    const day = String(date.getDate()).padStart(2, "0");
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }

  function updateFileDisplay(file: File | null) {
    selectedFile = file;
    if (file) {
      if (uploadZone) uploadZone.classList.add("has-file");
      if (selectedFileEl) selectedFileEl.hidden = false;
      if (selectedFileName) selectedFileName.textContent = file.name;
      if (uploadText)
        uploadText.innerHTML =
          "<strong>File selected</strong> - click to change";
    } else {
      if (uploadZone) uploadZone.classList.remove("has-file");
      if (selectedFileEl) selectedFileEl.hidden = true;
      if (selectedFileName) selectedFileName.textContent = "";
      if (uploadText)
        uploadText.innerHTML =
          "<strong>Click to select file</strong> or drag and drop";
      if (uploadInput) uploadInput.value = "";
    }
  }

  uploadInput?.addEventListener("change", (e) => {
    const files = (e.target as HTMLInputElement).files;
    if (files && files.length > 0) {
      const file = files[0];
      if (!isValidImageFile(file)) {
        if (uploadError) {
          uploadError.textContent =
            "Invalid file type. Only JPG, JPEG, PNG, and WEBP images are allowed.";
          uploadError.hidden = false;
        }
        updateFileDisplay(null);
        return;
      }
      if (uploadError) uploadError.hidden = true;
      updateFileDisplay(file);
    }
  });

  clearFileBtn?.addEventListener("click", () => {
    updateFileDisplay(null);
  });

  uploadZone?.addEventListener("dragover", (e) => {
    e.preventDefault();
    uploadZone.classList.add("dragover");
  });

  uploadZone?.addEventListener("dragleave", () => {
    uploadZone.classList.remove("dragover");
  });

  uploadZone?.addEventListener("drop", (e) => {
    e.preventDefault();
    uploadZone.classList.remove("dragover");
    const files = e.dataTransfer?.files;
    if (files && files.length > 0) {
      const file = files[0];
      if (!isValidImageFile(file)) {
        if (uploadError) {
          uploadError.textContent =
            "Invalid file type. Only JPG, JPEG, PNG, and WEBP images are allowed.";
          uploadError.hidden = false;
        }
        return;
      }
      if (uploadError) uploadError.hidden = true;
      updateFileDisplay(file);
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      if (uploadInput) uploadInput.files = dataTransfer.files;
    }
  });

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!selectedFile) {
      if (uploadError) {
        uploadError.textContent = "Please select a certificate file";
        uploadError.hidden = false;
      }
      return;
    }

    if (uploadError) uploadError.hidden = true;
    if (uploadSuccess) uploadSuccess.hidden = true;
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.innerHTML =
        '<span class="admin-spinner" style="width: 16px; height: 16px;"></span> Uploading...';
    }

    try {
      const formData = new FormData();

      formData.append("files", selectedFile);

      const title = (document.getElementById("title") as HTMLInputElement)
        ?.value;
      const issuer = (document.getElementById("issuer") as HTMLInputElement)
        ?.value;
      const issueDate = (
        document.getElementById("issue_date") as HTMLInputElement
      )?.value;
      const expiryDate = (
        document.getElementById("expiry_date") as HTMLInputElement
      )?.value;
      const credentialId = (
        document.getElementById("credential_id") as HTMLInputElement
      )?.value;
      const credentialUrl = (
        document.getElementById("credential_url") as HTMLInputElement
      )?.value;
      const description = (
        document.getElementById("description") as HTMLTextAreaElement
      )?.value;

      if (title) formData.append("title", title);
      if (issuer) formData.append("issuer", issuer);
      if (issueDate) formData.append("issue_date", formatDate(issueDate));
      if (expiryDate) formData.append("expiry_date", formatDate(expiryDate));
      if (credentialId) formData.append("credential_id", credentialId);
      if (credentialUrl) formData.append("credential_url", credentialUrl);
      if (description) formData.append("description", description);

      const response = await fetch("/api/admin/certifications", {
        method: "POST",
        body: formData,
        credentials: "include",
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || "Upload failed");
      }

      const result = data.data;
      if (uploadSuccess) {
        uploadSuccess.textContent = `Successfully uploaded "${title}"`;
        uploadSuccess.hidden = false;
      }

      setTimeout(() => window.location.reload(), 1000);
    } catch (err) {
      if (uploadError) {
        uploadError.textContent =
          err instanceof Error ? err.message : "Upload failed";
        uploadError.hidden = false;
      }
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = "Upload Certification";
      }
    }
  });

  resetFormBtn?.addEventListener("click", () => {
    form?.reset();
    updateFileDisplay(null);
    if (uploadError) uploadError.hidden = true;
    if (uploadSuccess) uploadSuccess.hidden = true;
  });

  function openDeleteModal(id: number, name: string) {
    currentDeleteId = id;
    const nameEl = document.getElementById("delete-item-name");
    if (nameEl) nameEl.textContent = name;
    (window as any).openModal("delete-modal");
  }

  document
    .getElementById("confirm-delete-btn")
    ?.addEventListener("click", async () => {
      if (!currentDeleteId) return;

      const errorEl = document.getElementById("delete-error");
      const btn = document.getElementById("confirm-delete-btn");

      if (btn) btn.textContent = "Deleting...";
      if (errorEl) errorEl.hidden = true;

      try {
        const response = await fetch(
          `/api/admin/certifications/${currentDeleteId}`,
          {
            method: "DELETE",
            credentials: "include",
          }
        );

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || "Failed to delete");
        }

        window.location.reload();
      } catch (err) {
        if (errorEl) {
          errorEl.textContent =
            err instanceof Error ? err.message : "An error occurred";
          errorEl.hidden = false;
        }
        if (btn) btn.textContent = "Delete";
      }
    });

  (window as any).openDeleteModal = openDeleteModal;
</script>
