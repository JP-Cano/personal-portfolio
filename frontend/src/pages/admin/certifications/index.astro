---
export const prerender = false;

import { api } from "@/api/api-client";
import Modal from "@/components/admin/Modal.astro";
import AdminLayout from "@/layouts/AdminLayout.astro";
import type { CareerCertifications } from "@/types/types";
import { API_PATHS } from "@/utils/constants";

const user = Astro.locals.user;

let certifications: CareerCertifications = [];
let error: string | null = null;

try {
  certifications = await api.get<CareerCertifications>(
    API_PATHS.UPLOAD_CERTIFICATES
  );
} catch (err) {
  error = err instanceof Error ? err.message : "Failed to load certifications";
}

const formatDate = (date: Date | string): string => {
  return new Date(date).toLocaleDateString("en-US", {
    year: "numeric",
    month: "short",
  });
};

const formatFileSize = (bytes: number): string => {
  if (bytes === 0) return "0 Bytes";
  const k = 1024;
  const sizes = ["Bytes", "KB", "MB", "GB"];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return `${Number.parseFloat((bytes / k ** i).toFixed(2))} ${sizes[i]}`;
};
---

<AdminLayout
  title="Certifications"
  currentPath="/admin/certifications"
  user={user}
>
  {error && <div class="admin-alert admin-alert-error">{error}</div>}

  <div class="admin-card" style="margin-bottom: 1.5rem;">
    <div class="admin-card-header">
      <h2 class="admin-card-title">Upload Certifications</h2>
    </div>

    <div id="upload-error" class="admin-alert admin-alert-error" hidden></div>
    <div id="upload-success" class="admin-alert admin-alert-success" hidden>
    </div>

    <div class="upload-zone" id="upload-zone">
      <input
        type="file"
        id="cert-upload"
        multiple
        accept="image/*,.pdf"
        style="display: none;"
      />
      <label for="cert-upload" class="upload-label">
        <div class="upload-icon">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
        </div>
        <p class="upload-text" id="upload-text">
          <strong>Click to upload</strong> or drag and drop
        </p>
        <p class="upload-hint">PNG, JPG, PDF up to 10MB</p>
      </label>
    </div>
  </div>

  <div class="admin-card">
    <div class="admin-card-header">
      <h2 class="admin-card-title">All Certifications</h2>
    </div>

    {
      certifications.length === 0 ? (
        <div class="admin-empty-state">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="48"
            height="48"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="8" r="7" />
            <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88" />
          </svg>
          <p>No certifications yet. Upload your first certificate!</p>
        </div>
      ) : (
        <div class="admin-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Certification</th>
                <th>Issue Date</th>
                <th>File</th>
                <th style="width: 80px">Actions</th>
              </tr>
            </thead>
            <tbody>
              {certifications.map((cert) => (
                <tr data-id={cert.id}>
                  <td>
                    <strong style="color: var(--admin-text)">
                      {cert.title}
                    </strong>
                    <div style="font-size: 0.8125rem; color: var(--admin-text-muted)">
                      {cert.issuer}
                    </div>
                  </td>
                  <td>{formatDate(cert.issue_date)}</td>
                  <td>
                    <a
                      href={cert.file_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      style="color: var(--admin-primary); font-size: 0.875rem;"
                    >
                      {cert.original_name}
                    </a>
                    <div style="font-size: 0.75rem; color: var(--admin-text-muted)">
                      {formatFileSize(cert.file_size)}
                    </div>
                  </td>
                  <td>
                    <div class="admin-table-actions">
                      <button
                        type="button"
                        class="admin-btn admin-btn-ghost admin-btn-sm admin-btn-icon"
                        onclick={`openDeleteModal(${cert.id}, '${cert.title.replace(/'/g, "\\'")}')`}
                        title="Delete"
                        style="color: var(--admin-danger)"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <polyline points="3 6 5 6 21 6" />
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                          <line x1="10" y1="11" x2="10" y2="17" />
                          <line x1="14" y1="11" x2="14" y2="17" />
                        </svg>
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )
    }
  </div>

  <Modal id="delete-modal" title="Delete Certification">
    <p class="admin-confirm-text">
      Are you sure you want to delete <strong id="delete-item-name"></strong>?
    </p>
    <p class="admin-confirm-warning">This action cannot be undone.</p>
    <div
      id="delete-error"
      class="admin-alert admin-alert-error"
      style="margin-top: 1rem;"
      hidden
    >
    </div>
    <div class="admin-form-actions">
      <button
        type="button"
        class="admin-btn admin-btn-ghost"
        onclick="closeModal('delete-modal')">Cancel</button
      >
      <button
        type="button"
        class="admin-btn admin-btn-danger"
        id="confirm-delete-btn">Delete</button
      >
    </div>
  </Modal>
</AdminLayout>

<style>
  .upload-zone {
    border: 2px dashed var(--admin-border);
    border-radius: 0.75rem;
    padding: 2rem;
    text-align: center;
    transition: all 0.2s ease;
  }

  .upload-zone:hover,
  .upload-zone.dragover {
    border-color: var(--admin-primary);
    background: rgba(99, 102, 241, 0.05);
  }

  .upload-label {
    cursor: pointer;
    display: block;
  }

  .upload-icon {
    color: var(--admin-text-muted);
    margin-bottom: 1rem;
  }

  .upload-text {
    color: var(--admin-text);
    margin: 0 0 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .upload-hint {
    color: var(--admin-text-muted);
    font-size: 0.8125rem;
    margin: 0;
  }
</style>

<script>
  let currentDeleteId: number | null = null;

  const uploadInput = document.getElementById(
    "cert-upload"
  ) as HTMLInputElement;
  const uploadZone = document.getElementById("upload-zone");
  const uploadText = document.getElementById("upload-text");
  const uploadError = document.getElementById("upload-error");
  const uploadSuccess = document.getElementById("upload-success");

  async function handleUpload(files: FileList | null) {
    if (!files || files.length === 0) return;

    if (uploadText)
      uploadText.innerHTML =
        '<span class="admin-spinner" style="width: 16px; height: 16px;"></span> Uploading...';
    if (uploadError) uploadError.hidden = true;
    if (uploadSuccess) uploadSuccess.hidden = true;

    try {
      const formData = new FormData();
      for (const file of Array.from(files)) {
        formData.append("files", file);
      }

      const response = await fetch("/api/admin/certifications", {
        method: "POST",
        body: formData,
        credentials: "include",
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || "Upload failed");
      }

      const result = data.data;
      if (uploadSuccess) {
        uploadSuccess.textContent = `Successfully uploaded ${result.successful} file(s)${result.failed > 0 ? `, ${result.failed} failed` : ""}`;
        uploadSuccess.hidden = false;
      }

      setTimeout(() => window.location.reload(), 1000);
    } catch (err) {
      if (uploadError) {
        uploadError.textContent =
          err instanceof Error ? err.message : "Upload failed";
        uploadError.hidden = false;
      }
      if (uploadText)
        uploadText.innerHTML =
          "<strong>Click to upload</strong> or drag and drop";
    }
  }

  uploadInput?.addEventListener("change", (e) => {
    handleUpload((e.target as HTMLInputElement).files);
  });

  // Drag and drop
  uploadZone?.addEventListener("dragover", (e) => {
    e.preventDefault();
    uploadZone.classList.add("dragover");
  });

  uploadZone?.addEventListener("dragleave", () => {
    uploadZone.classList.remove("dragover");
  });

  uploadZone?.addEventListener("drop", (e) => {
    e.preventDefault();
    uploadZone.classList.remove("dragover");
    handleUpload(e.dataTransfer?.files || null);
  });

  function openDeleteModal(id: number, name: string) {
    currentDeleteId = id;
    const nameEl = document.getElementById("delete-item-name");
    if (nameEl) nameEl.textContent = name;
    (window as any).openModal("delete-modal");
  }

  document
    .getElementById("confirm-delete-btn")
    ?.addEventListener("click", async () => {
      if (!currentDeleteId) return;

      const errorEl = document.getElementById("delete-error");
      const btn = document.getElementById("confirm-delete-btn");

      if (btn) btn.textContent = "Deleting...";
      if (errorEl) errorEl.hidden = true;

      try {
        const response = await fetch(
          `/api/admin/certifications/${currentDeleteId}`,
          {
            method: "DELETE",
            credentials: "include",
          }
        );

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || "Failed to delete");
        }

        window.location.reload();
      } catch (err) {
        if (errorEl) {
          errorEl.textContent =
            err instanceof Error ? err.message : "An error occurred";
          errorEl.hidden = false;
        }
        if (btn) btn.textContent = "Delete";
      }
    });

  (window as any).openDeleteModal = openDeleteModal;
</script>
